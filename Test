--[[
	Test script for Roblox game.
	Small UI that gets the local player and displays the player's name.
	Reference: Roblox/Referrence/JunkieKeySystem Example.lua
]]

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Remove any existing UI so we don't stack
local existing = PlayerGui:FindFirstChild("PlayerNameTest")
if existing then
	existing:Destroy()
end

-- Test: get player name
local function getPlayerName()
	return LocalPlayer.Name or "Unknown"
end

-- Build small UI
local screen = Instance.new("ScreenGui")
screen.Name = "PlayerNameTest"
screen.ResetOnSpawn = false
screen.Parent = PlayerGui

-- Speed slider range (Roblox default WalkSpeed is 16)
local MIN_WALK_SPEED = 8
local MAX_WALK_SPEED = 300
local DEFAULT_WALK_SPEED = 16

-- Objects list: only show instances whose Name contains any of these (case-insensitive)
local OBJECTS_LIST_NAME_FILTERS = { "Bubu", "Toffee", "Noob" }
-- Objects list: only show models whose FullName starts with this path (e.g. Workspace.Map.Zones.Field includes Field and all descendants); set to nil or "" to skip
local OBJECTS_LIST_PARENT_FILTER = "Workspace.Map.Zones.Field.NPC"

local workspace = game:GetService("Workspace")

local main = Instance.new("Frame")
main.Name = "Main"
main.Size = UDim2.new(0, 220, 0, 168)
main.Position = UDim2.new(0, 16, 0, 16)
main.BackgroundColor3 = Color3.fromRGB(20, 30, 50)
main.BorderSizePixel = 0
main.Active = true  -- allow dragging from window background
main.Parent = screen

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = main

-- Top bar (drag handle)
local top = Instance.new("Frame")
top.Name = "Top"
top.Size = UDim2.new(1, 0, 0, 28)
top.Position = UDim2.new(0, 0, 0, 0)
top.BackgroundColor3 = Color3.fromRGB(30, 60, 100)
top.BorderSizePixel = 0
top.Active = true  -- required for InputBegan to fire on drag handle
top.Parent = main

local topCorner = Instance.new("UICorner")
topCorner.CornerRadius = UDim.new(0, 10)
topCorner.Parent = top

local topCover = Instance.new("Frame")
topCover.Size = UDim2.new(1, 0, 0, 14)
topCover.Position = UDim2.new(0, 0, 1, -14)
topCover.BackgroundColor3 = Color3.fromRGB(30, 60, 100)
topCover.BorderSizePixel = 0
topCover.Parent = top

local bar = Instance.new("Frame")
bar.Name = "Bar"
bar.Size = UDim2.new(1, 0, 0, 4)
bar.Position = UDim2.new(0, 0, 0, 28)
bar.BackgroundColor3 = Color3.fromRGB(90, 170, 255)
bar.BorderSizePixel = 0
bar.Active = true  -- drag handle
bar.Parent = main

local barCorner = Instance.new("UICorner")
barCorner.CornerRadius = UDim.new(0, 2)
barCorner.Parent = bar

local title = Instance.new("TextLabel")
title.Name = "Title"
title.Size = UDim2.new(1, -44, 0, 28)
title.Position = UDim2.new(0, 8, 0, 0)
title.BackgroundTransparency = 1
title.Active = true  -- required for InputBegan to fire on drag handle
title.Text = "Player Name Test"
title.TextColor3 = Color3.fromRGB(200, 230, 255)
title.TextSize = 14
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = top

local closeBtn = Instance.new("TextButton")
closeBtn.Name = "Close"
closeBtn.Size = UDim2.new(0, 28, 0, 28)
closeBtn.Position = UDim2.new(1, -28, 0, 0)
closeBtn.BackgroundTransparency = 1
closeBtn.Text = "×"
closeBtn.TextColor3 = Color3.fromRGB(200, 230, 255)
closeBtn.TextSize = 20
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Parent = top

-- Drag state and connection (so we can disconnect when UI closes)
local mainDragging = false
local dragStart, startPos
local inputChangedConnection, inputEndedConnection

local function startDrag(inp)
	if inp.UserInputType == Enum.UserInputType.MouseButton1 then
		mainDragging = true
		dragStart = inp.Position
		startPos = main.Position
	end
end

-- Connect drag to top bar, title, bar, and main window background
top.InputBegan:Connect(startDrag)
title.InputBegan:Connect(startDrag)
bar.InputBegan:Connect(startDrag)
main.InputBegan:Connect(startDrag)

inputChangedConnection = UserInputService.InputChanged:Connect(function(inp)
	if mainDragging and inp.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = inp.Position - dragStart
		main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

inputEndedConnection = UserInputService.InputEnded:Connect(function(inp)
	if inp.UserInputType == Enum.UserInputType.MouseButton1 then
		mainDragging = false
	end
end)

closeBtn.MouseButton1Click:Connect(function()
	if inputChangedConnection then inputChangedConnection:Disconnect() inputChangedConnection = nil end
	if inputEndedConnection then inputEndedConnection:Disconnect() inputEndedConnection = nil end
	screen:Destroy()
end)

local nameLabel = Instance.new("TextLabel")
nameLabel.Name = "PlayerName"
nameLabel.Size = UDim2.new(1, -16, 0, 24)
nameLabel.Position = UDim2.new(0, 8, 0, 36)
nameLabel.BackgroundTransparency = 1
nameLabel.Text = getPlayerName()
nameLabel.TextColor3 = Color3.new(1, 1, 1)
nameLabel.TextSize = 16
nameLabel.Font = Enum.Font.Gotham
nameLabel.TextXAlignment = Enum.TextXAlignment.Left
nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
nameLabel.Parent = main

-- Keep UI in sync if display name or name changes
LocalPlayer:GetPropertyChangedSignal("Name"):Connect(function()
	nameLabel.Text = getPlayerName()
end)

-- Speed slider
local speedLabel = Instance.new("TextLabel")
speedLabel.Name = "SpeedLabel"
speedLabel.Size = UDim2.new(0, 60, 0, 20)
speedLabel.Position = UDim2.new(0, 8, 0, 64)
speedLabel.BackgroundTransparency = 1
speedLabel.Text = "Speed"
speedLabel.TextColor3 = Color3.fromRGB(200, 230, 255)
speedLabel.TextSize = 12
speedLabel.Font = Enum.Font.Gotham
speedLabel.TextXAlignment = Enum.TextXAlignment.Left
speedLabel.Parent = main

local speedValueLabel = Instance.new("TextLabel")
speedValueLabel.Name = "SpeedValue"
speedValueLabel.Size = UDim2.new(0, 44, 0, 20)
speedValueLabel.Position = UDim2.new(1, -52, 0, 64)
speedValueLabel.BackgroundTransparency = 1
speedValueLabel.Text = tostring(DEFAULT_WALK_SPEED)
speedValueLabel.TextColor3 = Color3.fromRGB(200, 230, 255)
speedValueLabel.TextSize = 12
speedValueLabel.Font = Enum.Font.Gotham
speedValueLabel.TextXAlignment = Enum.TextXAlignment.Right
speedValueLabel.Parent = main

local sliderTrack = Instance.new("Frame")
sliderTrack.Name = "SliderTrack"
sliderTrack.Size = UDim2.new(1, -16, 0, 12)
sliderTrack.Position = UDim2.new(0, 8, 0, 88)
sliderTrack.BackgroundColor3 = Color3.fromRGB(40, 50, 70)
sliderTrack.BorderSizePixel = 0
sliderTrack.Active = true
sliderTrack.Parent = main

local sliderTrackCorner = Instance.new("UICorner")
sliderTrackCorner.CornerRadius = UDim.new(0, 6)
sliderTrackCorner.Parent = sliderTrack

local sliderFill = Instance.new("Frame")
sliderFill.Name = "Fill"
sliderFill.Size = UDim2.new(0, 0, 1, 0)
sliderFill.Position = UDim2.new(0, 0, 0, 0)
sliderFill.BackgroundColor3 = Color3.fromRGB(90, 170, 255)
sliderFill.BorderSizePixel = 0
sliderFill.ZIndex = 0
sliderFill.Parent = sliderTrack

local sliderFillCorner = Instance.new("UICorner")
sliderFillCorner.CornerRadius = UDim.new(0, 6)
sliderFillCorner.Parent = sliderFill

local sliderThumb = Instance.new("Frame")
sliderThumb.Name = "Thumb"
sliderThumb.Size = UDim2.new(0, 14, 0, 14)
sliderThumb.Position = UDim2.new(0, -7, 0.5, -7)
sliderThumb.AnchorPoint = Vector2.new(0.5, 0.5)
sliderThumb.BackgroundColor3 = Color3.fromRGB(200, 230, 255)
sliderThumb.BorderSizePixel = 0
sliderThumb.ZIndex = 1
sliderThumb.Active = true
sliderThumb.Parent = sliderTrack

local sliderThumbCorner = Instance.new("UICorner")
sliderThumbCorner.CornerRadius = UDim.new(1, 0)
sliderThumbCorner.Parent = sliderThumb

-- Objects list button
local objectsBtn = Instance.new("TextButton")
objectsBtn.Name = "Objects"
objectsBtn.Size = UDim2.new(1, -16, 0, 28)
objectsBtn.Position = UDim2.new(0, 8, 0, 108)
objectsBtn.BackgroundColor3 = Color3.fromRGB(40, 70, 120)
objectsBtn.BorderSizePixel = 0
objectsBtn.Text = "Spawned Bubus 6"
objectsBtn.TextColor3 = Color3.fromRGB(200, 230, 255)
objectsBtn.TextSize = 12
objectsBtn.Font = Enum.Font.Gotham
objectsBtn.Parent = main

local objectsBtnCorner = Instance.new("UICorner")
objectsBtnCorner.CornerRadius = UDim.new(0, 6)
objectsBtnCorner.Parent = objectsBtn

-- Objects list window (new window when button clicked)
local function openObjectsWindow()
	local existingObjGui = PlayerGui:FindFirstChild("PlayerNameTest_ObjectsList")
	if existingObjGui then
		existingObjGui:Destroy()
	end

	local objScreen = Instance.new("ScreenGui")
	objScreen.Name = "PlayerNameTest_ObjectsList"
	objScreen.ResetOnSpawn = false
	objScreen.Parent = PlayerGui

	local objMain = Instance.new("Frame")
	objMain.Name = "Main"
	objMain.Size = UDim2.new(0, 320, 0, 400)
	objMain.Position = UDim2.new(0.5, -160, 0.5, -200)
	objMain.AnchorPoint = Vector2.new(0.5, 0.5)
	objMain.BackgroundColor3 = Color3.fromRGB(20, 30, 50)
	objMain.BorderSizePixel = 0
	objMain.Active = true  -- allow dragging from window background
	objMain.Parent = objScreen

	local objCorner = Instance.new("UICorner")
	objCorner.CornerRadius = UDim.new(0, 10)
	objCorner.Parent = objMain

	local objTop = Instance.new("Frame")
	objTop.Name = "Top"
	objTop.Size = UDim2.new(1, 0, 0, 28)
	objTop.Position = UDim2.new(0, 0, 0, 0)
	objTop.BackgroundColor3 = Color3.fromRGB(30, 60, 100)
	objTop.BorderSizePixel = 0
	objTop.Active = true
	objTop.Parent = objMain

	local objTopCorner = Instance.new("UICorner")
	objTopCorner.CornerRadius = UDim.new(0, 10)
	objTopCorner.Parent = objTop

	local objTitle = Instance.new("TextLabel")
	objTitle.Name = "Title"
	objTitle.Size = UDim2.new(1, -84, 0, 28)
	objTitle.Position = UDim2.new(0, 8, 0, 0)
	objTitle.BackgroundTransparency = 1
	objTitle.Active = true
	objTitle.Text = "Spawned Bubus"
	objTitle.TextColor3 = Color3.fromRGB(200, 230, 255)
	objTitle.TextSize = 14
	objTitle.Font = Enum.Font.GothamBold
	objTitle.TextXAlignment = Enum.TextXAlignment.Left
	objTitle.Parent = objTop

	local objCloseBtn = Instance.new("TextButton")
	objCloseBtn.Name = "Close"
	objCloseBtn.Size = UDim2.new(0, 28, 0, 28)
	objCloseBtn.Position = UDim2.new(1, -28, 0, 0)
	objCloseBtn.BackgroundTransparency = 1
	objCloseBtn.Text = "×"
	objCloseBtn.TextColor3 = Color3.fromRGB(200, 230, 255)
	objCloseBtn.TextSize = 20
	objCloseBtn.Font = Enum.Font.GothamBold
	objCloseBtn.Parent = objTop

	-- Drag for objects window
	local objDragging = false
	local objDragStart, objStartPos
	local objInputChangedConn, objInputEndedConn
	local function onObjDragStart(inp)
		if inp.UserInputType == Enum.UserInputType.MouseButton1 then
			objDragging = true
			objDragStart = inp.Position
			objStartPos = objMain.Position
		end
	end
	objTop.InputBegan:Connect(onObjDragStart)
	objTitle.InputBegan:Connect(onObjDragStart)
	objMain.InputBegan:Connect(onObjDragStart)
	objInputChangedConn = UserInputService.InputChanged:Connect(function(inp)
		if objDragging and inp.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = inp.Position - objDragStart
			objMain.Position = UDim2.new(objStartPos.X.Scale, objStartPos.X.Offset + delta.X, objStartPos.Y.Scale, objStartPos.Y.Offset + delta.Y)
		end
	end)
	objInputEndedConn = UserInputService.InputEnded:Connect(function(inp)
		if inp.UserInputType == Enum.UserInputType.MouseButton1 then
			objDragging = false
		end
	end)

	objCloseBtn.MouseButton1Click:Connect(function()
		if objInputChangedConn then objInputChangedConn:Disconnect() end
		if objInputEndedConn then objInputEndedConn:Disconnect() end
		objScreen:Destroy()
	end)

	-- Refresh button (manual refresh only)
	local objRefreshBtn = Instance.new("TextButton")
	objRefreshBtn.Name = "Refresh"
	objRefreshBtn.Size = UDim2.new(0, 56, 0, 28)
	objRefreshBtn.Position = UDim2.new(1, -84, 0, 0)
	objRefreshBtn.BackgroundTransparency = 1
	objRefreshBtn.Text = "Refresh"
	objRefreshBtn.TextColor3 = Color3.fromRGB(200, 230, 255)
	objRefreshBtn.TextSize = 12
	objRefreshBtn.Font = Enum.Font.Gotham
	objRefreshBtn.Parent = objTop

	-- Scrollable list (full width)
	local scroll = Instance.new("ScrollingFrame")
	scroll.Name = "List"
	scroll.Size = UDim2.new(1, -16, 1, -44)
	scroll.Position = UDim2.new(0, 8, 0, 36)
	scroll.BackgroundColor3 = Color3.fromRGB(25, 35, 55)
	scroll.BorderSizePixel = 0
	scroll.ScrollBarThickness = 6
	scroll.ScrollBarImageColor3 = Color3.fromRGB(90, 170, 255)
	scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
	scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
	scroll.Parent = objMain

	local scrollCorner = Instance.new("UICorner")
	scrollCorner.CornerRadius = UDim.new(0, 6)
	scrollCorner.Parent = scroll

	local listLayout = Instance.new("UIListLayout")
	listLayout.Padding = UDim.new(0, 2)
	listLayout.SortOrder = Enum.SortOrder.LayoutOrder
	listLayout.Parent = scroll

	local workspace = game:GetService("Workspace")
	local ROW_HEIGHT = 22

	-- Get text from CharacterInfo BillboardGui label by name (e.g. "Rarity", "Income", "CharTime")
	local function getCharacterInfoLabel(model, labelName)
		for _, desc in ipairs(model:GetDescendants()) do
			if desc:IsA("BillboardGui") and desc.Name == "CharacterInfo" then
				local lbl = desc:FindFirstChild(labelName, true)
				if lbl and (lbl:IsA("TextLabel") or lbl:IsA("TextButton")) and lbl.Text then
					return lbl.Text
				end
				break
			end
		end
		local charInfo = model:FindFirstChild("CharacterInfo", true)
		if charInfo then
			local gui = charInfo:IsA("BillboardGui") and charInfo or charInfo:FindFirstChildOfClass("BillboardGui")
			if gui then
				local lbl = gui:FindFirstChild(labelName, true)
				if lbl and (lbl:IsA("TextLabel") or lbl:IsA("TextButton")) and lbl.Text then
					return lbl.Text
				end
			end
		end
		return nil
	end

	-- List row: NPCId - Mutation - Rarity - Income - CharTime (no click needed to see info)
	local function getNPCDisplayLabel(model)
		local npcId = tostring(model:GetAttribute("NPCId") or "?")
		local mutation = tostring(model:GetAttribute("Mutation") or "?")
		local rarity = getCharacterInfoLabel(model, "Rarity") or "?"
		local income = getCharacterInfoLabel(model, "Income") or "?"
		local charTime = getCharacterInfoLabel(model, "CharTime") or "?"
		return npcId .. " - " .. mutation .. " - " .. rarity .. " - " .. income .. " - " .. charTime
	end

	local function addRow(model, layoutOrder)
		local row = Instance.new("TextButton")
		row.Name = model.Name
		row.Size = UDim2.new(1, -8, 0, ROW_HEIGHT)
		row.BackgroundColor3 = Color3.fromRGB(35, 50, 75)
		row.BorderSizePixel = 0
		row.LayoutOrder = layoutOrder
		row.Text = ""
		row.AutoButtonColor = true
		row.Parent = scroll
		local rowCorner = Instance.new("UICorner")
		rowCorner.CornerRadius = UDim.new(0, 4)
		rowCorner.Parent = row
		local lbl = Instance.new("TextLabel")
		lbl.Size = UDim2.new(1, -8, 1, -4)
		lbl.Position = UDim2.new(0, 6, 0, 2)
		lbl.BackgroundTransparency = 1
		lbl.Text = getNPCDisplayLabel(model)
		lbl.TextColor3 = Color3.fromRGB(200, 220, 255)
		lbl.TextSize = 11
		lbl.Font = Enum.Font.Gotham
		lbl.TextXAlignment = Enum.TextXAlignment.Left
		lbl.TextTruncate = Enum.TextTruncate.AtEnd
		lbl.Parent = row
		return row
	end

	local function refreshList()
		for _, child in ipairs(scroll:GetChildren()) do
			if child ~= listLayout then
				child:Destroy()
			end
		end
		-- List only Model instances under path filter and with Mutation ~= "Normal"
		local objects = workspace:GetDescendants()
		local order = 0
		local prefix = OBJECTS_LIST_PARENT_FILTER
		for _, obj in ipairs(objects) do
			if obj.ClassName == "Model" then
				local fullName = obj:GetFullName()
				local parentMatch = not prefix or prefix == ""
					or (fullName == prefix or string.sub(fullName, 1, #prefix + 1) == prefix .. ".")
				if parentMatch then
					local mutation = obj:GetAttribute("Mutation")
					if mutation ~= nil and mutation ~= "Normal" then
						order = order + 1
						addRow(obj, order)
					end
				end
			end
		end
	end

	refreshList()

	objRefreshBtn.MouseButton1Click:Connect(refreshList)

	-- Auto-refresh list every 5 seconds while window is open
	task.spawn(function()
		while objScreen.Parent do
			task.wait(5)
			if not objScreen.Parent then break end
			refreshList()
		end
	end)
end

objectsBtn.MouseButton1Click:Connect(openObjectsWindow)

-- Current speed value (0–1)
local speedNorm = (DEFAULT_WALK_SPEED - MIN_WALK_SPEED) / (MAX_WALK_SPEED - MIN_WALK_SPEED)

local function speedFromNorm(norm)
	norm = math.clamp(norm, 0, 1)
	return math.floor(MIN_WALK_SPEED + (MAX_WALK_SPEED - MIN_WALK_SPEED) * norm + 0.5)
end

local function normFromSpeed(speed)
	return (math.clamp(speed, MIN_WALK_SPEED, MAX_WALK_SPEED) - MIN_WALK_SPEED) / (MAX_WALK_SPEED - MIN_WALK_SPEED)
end

local function applySpeedToCharacter(speed)
	local character = LocalPlayer.Character
	if character then
		local humanoid = character:FindFirstChildOfClass("Humanoid")
		if humanoid then
			humanoid.WalkSpeed = speed
		end
	end
end

local function setSpeedFromNorm(norm)
	norm = math.clamp(norm, 0, 1)
	speedNorm = norm
	local speed = speedFromNorm(norm)
	speedValueLabel.Text = tostring(speed)
	sliderFill.Size = UDim2.new(norm, 0, 1, 0)
	sliderThumb.Position = UDim2.new(norm, -7, 0.5, -7)
	applySpeedToCharacter(speed)
end

local function updateSliderFromMouse(x)
	local trackAbs = sliderTrack.AbsolutePosition.X
	local trackSize = sliderTrack.AbsoluteSize.X
	local rel = (x - trackAbs) / math.max(trackSize, 1)
	setSpeedFromNorm(rel)
end

-- Slider drag state
local sliderDragging = false
local sliderInputConnection

local function beginSliderDrag()
	sliderDragging = true
	sliderInputConnection = UserInputService.InputChanged:Connect(function(inp)
		if inp.UserInputType == Enum.UserInputType.MouseMovement then
			-- Only update slider when mouse is over the track
			local trackPos = sliderTrack.AbsolutePosition
			local trackSize = sliderTrack.AbsoluteSize
			local x, y = inp.Position.X, inp.Position.Y
			if x >= trackPos.X and x <= trackPos.X + trackSize.X and y >= trackPos.Y and y <= trackPos.Y + trackSize.Y then
				updateSliderFromMouse(x)
			end
		end
	end)
	local endConn
	endConn = UserInputService.InputEnded:Connect(function(inp)
		if inp.UserInputType == Enum.UserInputType.MouseButton1 then
			sliderDragging = false
			if sliderInputConnection then sliderInputConnection:Disconnect() end
			endConn:Disconnect()
		end
	end)
end

sliderTrack.InputBegan:Connect(function(inp)
	if inp.UserInputType == Enum.UserInputType.MouseButton1 then
		updateSliderFromMouse(inp.Position.X)
		beginSliderDrag()
	end
end)

sliderThumb.InputBegan:Connect(function(inp)
	if inp.UserInputType == Enum.UserInputType.MouseButton1 then
		beginSliderDrag()
	end
end)

-- Initialize slider position and apply default speed
setSpeedFromNorm(speedNorm)

-- Apply speed when character spawns/respawns
LocalPlayer.CharacterAdded:Connect(function(character)
	local humanoid = character:WaitForChild("Humanoid", 5)
	if humanoid then
		humanoid.WalkSpeed = speedFromNorm(speedNorm)
	end
end)

-- If character already exists, set WalkSpeed once
if LocalPlayer.Character then
	applySpeedToCharacter(speedFromNorm(speedNorm))
end

print("Player name:", getPlayerName())
