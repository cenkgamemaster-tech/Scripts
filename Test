--[[
	Test script for Roblox game.
	Small UI that gets the local player and displays the player's name.
	Reference: Roblox/Referrence/JunkieKeySystem Example.lua
]]

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Remove any existing UI so we don't stack
local existing = PlayerGui:FindFirstChild("PlayerNameTest")
if existing then
	existing:Destroy()
end

-- Test: get player name
local function getPlayerName()
	return LocalPlayer.Name or "Unknown"
end

-- Build small UI
local screen = Instance.new("ScreenGui")
screen.Name = "PlayerNameTest"
screen.ResetOnSpawn = false
screen.Parent = PlayerGui

-- Speed slider range (Roblox default WalkSpeed is 16)
local MIN_WALK_SPEED = 8
local MAX_WALK_SPEED = 300
local DEFAULT_WALK_SPEED = 16

local main = Instance.new("Frame")
main.Name = "Main"
main.Size = UDim2.new(0, 220, 0, 138)
main.Position = UDim2.new(0, 16, 0, 16)
main.BackgroundColor3 = Color3.fromRGB(20, 30, 50)
main.BorderSizePixel = 0
main.Parent = screen

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = main

-- Top bar (drag handle)
local top = Instance.new("Frame")
top.Name = "Top"
top.Size = UDim2.new(1, 0, 0, 28)
top.Position = UDim2.new(0, 0, 0, 0)
top.BackgroundColor3 = Color3.fromRGB(30, 60, 100)
top.BorderSizePixel = 0
top.Active = true  -- required for InputBegan to fire on drag handle
top.Parent = main

local topCorner = Instance.new("UICorner")
topCorner.CornerRadius = UDim.new(0, 10)
topCorner.Parent = top

local topCover = Instance.new("Frame")
topCover.Size = UDim2.new(1, 0, 0, 14)
topCover.Position = UDim2.new(0, 0, 1, -14)
topCover.BackgroundColor3 = Color3.fromRGB(30, 60, 100)
topCover.BorderSizePixel = 0
topCover.Parent = top

local bar = Instance.new("Frame")
bar.Name = "Bar"
bar.Size = UDim2.new(1, 0, 0, 4)
bar.Position = UDim2.new(0, 0, 0, 28)
bar.BackgroundColor3 = Color3.fromRGB(90, 170, 255)
bar.BorderSizePixel = 0
bar.Parent = main

local barCorner = Instance.new("UICorner")
barCorner.CornerRadius = UDim.new(0, 2)
barCorner.Parent = bar

local title = Instance.new("TextLabel")
title.Name = "Title"
title.Size = UDim2.new(1, -44, 0, 28)
title.Position = UDim2.new(0, 8, 0, 0)
title.BackgroundTransparency = 1
title.Active = true  -- required for InputBegan to fire on drag handle
title.Text = "Player Name Test"
title.TextColor3 = Color3.fromRGB(200, 230, 255)
title.TextSize = 14
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = top

local closeBtn = Instance.new("TextButton")
closeBtn.Name = "Close"
closeBtn.Size = UDim2.new(0, 28, 0, 28)
closeBtn.Position = UDim2.new(1, -28, 0, 0)
closeBtn.BackgroundTransparency = 1
closeBtn.Text = "×"
closeBtn.TextColor3 = Color3.fromRGB(200, 230, 255)
closeBtn.TextSize = 20
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Parent = top

-- Drag state and connection (so we can disconnect when UI closes)
local dragInput, dragStart, startPos
local inputChangedConnection

local function startDrag(inp)
	if inp.UserInputType == Enum.UserInputType.MouseButton1 then
		dragInput = inp
		dragStart = inp.Position
		startPos = main.Position
		local conn
		conn = inp.Changed:Connect(function()
			if inp.UserInputState == Enum.UserInputState.End then
				dragInput = nil
				if conn then conn:Disconnect() end
			end
		end)
	end
end

-- Connect drag to both top frame and title (title covers most of the bar, so we need both)
top.InputBegan:Connect(startDrag)
title.InputBegan:Connect(startDrag)

inputChangedConnection = UserInputService.InputChanged:Connect(function(inp)
	if dragInput and inp == dragInput and inp.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = inp.Position - dragStart
		main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

closeBtn.MouseButton1Click:Connect(function()
	if inputChangedConnection then
		inputChangedConnection:Disconnect()
		inputChangedConnection = nil
	end
	screen:Destroy()
end)

local nameLabel = Instance.new("TextLabel")
nameLabel.Name = "PlayerName"
nameLabel.Size = UDim2.new(1, -16, 0, 24)
nameLabel.Position = UDim2.new(0, 8, 0, 36)
nameLabel.BackgroundTransparency = 1
nameLabel.Text = getPlayerName()
nameLabel.TextColor3 = Color3.new(1, 1, 1)
nameLabel.TextSize = 16
nameLabel.Font = Enum.Font.Gotham
nameLabel.TextXAlignment = Enum.TextXAlignment.Left
nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
nameLabel.Parent = main

-- Keep UI in sync if display name or name changes
LocalPlayer:GetPropertyChangedSignal("Name"):Connect(function()
	nameLabel.Text = getPlayerName()
end)

-- Speed slider
local speedLabel = Instance.new("TextLabel")
speedLabel.Name = "SpeedLabel"
speedLabel.Size = UDim2.new(0, 60, 0, 20)
speedLabel.Position = UDim2.new(0, 8, 0, 64)
speedLabel.BackgroundTransparency = 1
speedLabel.Text = "Speed"
speedLabel.TextColor3 = Color3.fromRGB(200, 230, 255)
speedLabel.TextSize = 12
speedLabel.Font = Enum.Font.Gotham
speedLabel.TextXAlignment = Enum.TextXAlignment.Left
speedLabel.Parent = main

local speedValueLabel = Instance.new("TextLabel")
speedValueLabel.Name = "SpeedValue"
speedValueLabel.Size = UDim2.new(0, 36, 0, 20)
speedValueLabel.Position = UDim2.new(1, -44, 0, 64)
speedValueLabel.BackgroundTransparency = 1
speedValueLabel.Text = tostring(DEFAULT_WALK_SPEED)
speedValueLabel.TextColor3 = Color3.fromRGB(200, 230, 255)
speedValueLabel.TextSize = 12
speedValueLabel.Font = Enum.Font.Gotham
speedValueLabel.TextXAlignment = Enum.TextXAlignment.Right
speedValueLabel.Parent = main

local sliderTrack = Instance.new("Frame")
sliderTrack.Name = "SliderTrack"
sliderTrack.Size = UDim2.new(1, -16, 0, 12)
sliderTrack.Position = UDim2.new(0, 8, 0, 88)
sliderTrack.BackgroundColor3 = Color3.fromRGB(40, 50, 70)
sliderTrack.BorderSizePixel = 0
sliderTrack.Active = true
sliderTrack.Parent = main

local sliderTrackCorner = Instance.new("UICorner")
sliderTrackCorner.CornerRadius = UDim.new(0, 6)
sliderTrackCorner.Parent = sliderTrack

local sliderFill = Instance.new("Frame")
sliderFill.Name = "Fill"
sliderFill.Size = UDim2.new(0, 0, 1, 0)
sliderFill.Position = UDim2.new(0, 0, 0, 0)
sliderFill.BackgroundColor3 = Color3.fromRGB(90, 170, 255)
sliderFill.BorderSizePixel = 0
sliderFill.ZIndex = 0
sliderFill.Parent = sliderTrack

local sliderFillCorner = Instance.new("UICorner")
sliderFillCorner.CornerRadius = UDim.new(0, 6)
sliderFillCorner.Parent = sliderFill

local sliderThumb = Instance.new("Frame")
sliderThumb.Name = "Thumb"
sliderThumb.Size = UDim2.new(0, 14, 0, 14)
sliderThumb.Position = UDim2.new(0, -7, 0.5, -7)
sliderThumb.AnchorPoint = Vector2.new(0.5, 0.5)
sliderThumb.BackgroundColor3 = Color3.fromRGB(200, 230, 255)
sliderThumb.BorderSizePixel = 0
sliderThumb.ZIndex = 1
sliderThumb.Active = true
sliderThumb.Parent = sliderTrack

local sliderThumbCorner = Instance.new("UICorner")
sliderThumbCorner.CornerRadius = UDim.new(1, 0)
sliderThumbCorner.Parent = sliderThumb

-- Current speed value (0–1)
local speedNorm = (DEFAULT_WALK_SPEED - MIN_WALK_SPEED) / (MAX_WALK_SPEED - MIN_WALK_SPEED)

local function speedFromNorm(norm)
	norm = math.clamp(norm, 0, 1)
	return math.floor(MIN_WALK_SPEED + (MAX_WALK_SPEED - MIN_WALK_SPEED) * norm + 0.5)
end

local function normFromSpeed(speed)
	return (math.clamp(speed, MIN_WALK_SPEED, MAX_WALK_SPEED) - MIN_WALK_SPEED) / (MAX_WALK_SPEED - MIN_WALK_SPEED)
end

local function applySpeedToCharacter(speed)
	local character = LocalPlayer.Character
	if character then
		local humanoid = character:FindFirstChildOfClass("Humanoid")
		if humanoid then
			humanoid.WalkSpeed = speed
		end
	end
end

local function setSpeedFromNorm(norm)
	norm = math.clamp(norm, 0, 1)
	speedNorm = norm
	local speed = speedFromNorm(norm)
	speedValueLabel.Text = tostring(speed)
	sliderFill.Size = UDim2.new(norm, 0, 1, 0)
	sliderThumb.Position = UDim2.new(norm, -7, 0.5, -7)
	applySpeedToCharacter(speed)
end

local function updateSliderFromMouse(x)
	local trackAbs = sliderTrack.AbsolutePosition.X
	local trackSize = sliderTrack.AbsoluteSize.X
	local rel = (x - trackAbs) / math.max(trackSize, 1)
	setSpeedFromNorm(rel)
end

-- Slider drag state
local sliderDragging = false
local sliderInputConnection

local function beginSliderDrag()
	sliderDragging = true
	sliderInputConnection = UserInputService.InputChanged:Connect(function(inp)
		if inp.UserInputType == Enum.UserInputType.MouseMovement then
			updateSliderFromMouse(inp.Position.X)
		end
	end)
	local endConn
	endConn = UserInputService.InputEnded:Connect(function(inp)
		if inp.UserInputType == Enum.UserInputType.MouseButton1 then
			sliderDragging = false
			if sliderInputConnection then sliderInputConnection:Disconnect() end
			endConn:Disconnect()
		end
	end)
end

sliderTrack.InputBegan:Connect(function(inp)
	if inp.UserInputType == Enum.UserInputType.MouseButton1 then
		updateSliderFromMouse(inp.Position.X)
		beginSliderDrag()
	end
end)

sliderThumb.InputBegan:Connect(function(inp)
	if inp.UserInputType == Enum.UserInputType.MouseButton1 then
		beginSliderDrag()
	end
end)

-- Initialize slider position and apply default speed
setSpeedFromNorm(speedNorm)

-- Apply speed when character spawns/respawns
LocalPlayer.CharacterAdded:Connect(function(character)
	local humanoid = character:WaitForChild("Humanoid", 5)
	if humanoid then
		humanoid.WalkSpeed = speedFromNorm(speedNorm)
	end
end)

-- If character already exists, set WalkSpeed once
if LocalPlayer.Character then
	applySpeedToCharacter(speedFromNorm(speedNorm))
end

print("Player name:", getPlayerName())
